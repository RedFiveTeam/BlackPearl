!function(t,e){"object"==typeof exports&&"undefined"!=typeof module?e(exports,require("sift")):"function"==typeof define&&define.amd?define(["exports","sift"],e):e(t.casl={},t.sift)}(this,function(t,n){"use strict";function u(t){var e=1<arguments.length&&void 0!==arguments[1]?arguments[1]:{};Error.call(this),this.constructor=u,this.subject=e.subject,this.subjectName=e.subjectName,this.action=e.action,this.field=e.field,this.message=t||'Cannot execute "'+this.action+'" on "'+this.subjectName+'"',"function"==typeof Error.captureStackTrace?(this.name=this.constructor.name,Error.captureStackTrace(this,this.constructor)):this.stack=new Error(this.message).stack}n=n&&n.hasOwnProperty("default")?n.default:n,u.prototype=Object.create(Error.prototype);var r="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(t){return typeof t}:function(t){return t&&"function"==typeof Symbol&&t.constructor===Symbol&&t!==Symbol.prototype?"symbol":typeof t},c=function(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")},e=function(){function r(t,e){for(var n=0;n<e.length;n++){var r=e[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(t,r.key,r)}}return function(t,e,n){return e&&r(t.prototype,e),n&&r(t,n),t}}();function l(t){return Array.isArray(t)?t:[t]}function f(t){if(!t||"string"==typeof t)return t;var e="object"===(void 0===t?"undefined":r(t))?t.constructor:t;return e.modelName||e.name}var h=function(){function e(t){c(this,e),this.actions=t.actions||t.action,this.subject=t.subject,this.fields=t.fields&&0!==t.fields.length?l(t.fields):void 0,this.inverted=!!t.inverted,this.conditions=t.conditions,this._matches=this.conditions?n(this.conditions):void 0,this.reason=t.reason}return e.prototype.matches=function(t){return!this._matches||("string"==typeof t?!this.inverted:this._matches(t))},e.prototype.isRelevantFor=function(t,e){return!this.fields||(e?-1!==this.fields.indexOf(e):!this.inverted)},e}();var p={manage:["create","read","update","delete"]},d="undefined"!=typeof Symbol?Symbol("private"):"__"+Date.now(),a=function(){function a(t){var e,n=1<arguments.length&&void 0!==arguments[1]?arguments[1]:{},r=n.RuleType,i=void 0===r?h:r,o=n.subjectName,s=void 0===o?f:o;c(this,a),this[d]={RuleType:i,subjectName:s,originalRules:t||[],rules:{},events:{},aliases:(e=p,JSON.parse(JSON.stringify(e)))},this.update(t)}return a.addAlias=function(t,e){if(t===e||Array.isArray(e)&&-1!==e.indexOf(t))throw new Error("Attempt to alias action to itself: "+t+" -> "+e.toString());return p[t]=e,this},a.prototype.update=function(t){if(Array.isArray(t)){var e={rules:t,ability:this};this.emit("update",e),this[d].originalRules=Object.freeze(t.slice(0)),this[d].rules=this.buildIndexFor(this.rules),this.emit("updated",e)}return this},a.prototype.buildIndexFor=function(t){for(var e={},n=this[d].RuleType,r=0;r<t.length;r++)for(var i=new n(t[r]),o=this.expandActions(i.actions),s=l(i.subject),a=0;a<s.length;a++){var u=s[a];e[u]=e[u]||{};for(var c=0;c<o.length;c++){var f=o[c];e[u][f]=e[u][f]||[],e[u][f].unshift(i)}}return e},a.prototype.expandActions=function(t){for(var e=this[d].aliases,n=l(t),r=0;r<n.length;){var i=n[r++];e.hasOwnProperty(i)&&(n=n.concat(e[i]))}return n},a.prototype.can=function(t,e,n){var r=this.relevantRuleFor(t,e,n);return!!r&&!r.inverted},a.prototype.relevantRuleFor=function(t,e,n){for(var r=this.rulesFor(t,e,n),i=0;i<r.length;i++)if(r[i].matches(e))return r[i];return null},a.prototype.possibleRulesFor=function(t,e){var n=this[d].subjectName(e),r=this[d].rules,i=r.hasOwnProperty(n)?r[n][t]:null,o=r.hasOwnProperty("all")?r.all[t]:null;return(i||[]).concat(o||[])},a.prototype.rulesFor=function(t,e,n){return this.possibleRulesFor(t,e).filter(function(t){return t.isRelevantFor(e,n)})},a.prototype.cannot=function(){return!this.can.apply(this,arguments)},a.prototype.throwUnlessCan=function(){for(var t=arguments.length,e=Array(t),n=0;n<t;n++)e[n]=arguments[n];var r=this.relevantRuleFor.apply(this,e);if(!r||r.inverted){var i=e[0],o=e[1],s=e[2],a=this[d].subjectName(o);throw new u(r?r.reason:null,{action:i,subjectName:a,subject:o,field:s})}},a.prototype.on=function(e,n){var r=this[d].events,i=!0;return r[e]||(r[e]=[]),r[e].push(n),function(){if(i){var t=r[e].indexOf(n);r[e].splice(t,1),i=!1}}},a.prototype.emit=function(t,e){var n=this[d].events[t];n&&n.forEach(function(t){return t(e)})},e(a,[{key:"rules",get:function(){return this[d].originalRules}}]),a}();function s(t){return![].concat(t).some(function(t){return"string"!=typeof t})}function y(t){return t&&"object"===(void 0===t?"undefined":r(t))}var v=function(){function e(t){c(this,e),this.rule=t}return e.prototype.because=function(t){return this.rule.reason=t,this},e}(),i=function(){function n(){var t=(0<arguments.length&&void 0!==arguments[0]?arguments[0]:{}).subjectName,e=void 0===t?f:t;c(this,n),this.rules=[],this.subjectName=e}return n.define=function(t,e){var n="function"==typeof t?{}:t,r=t===n?e:t,i=new this(n),o=r(i.can.bind(i),i.cannot.bind(i)),s=function(){return new a(i.rules,n)};return o&&"function"==typeof o.then?o.then(s):s()},n.extract=function(){var t=new this;return{can:t.can.bind(t),cannot:t.cannot.bind(t),rules:t.rules}},n.prototype.can=function(t,e,n,r){if(!s(t))throw new TypeError("AbilityBuilder#can expects the first parameter to be an action or array of actions");var i=[].concat(e).map(this.subjectName);if(!s(i))throw new TypeError("AbilityBuilder#can expects the second argument to be a subject name/type or an array of subject names/types");var o={actions:t,subject:i};return(Array.isArray(n)||"string"==typeof n)&&(o.fields=n),(y(r)||!o.fields&&y(n))&&(o.conditions=r||n),this.rules.push(o),new v(o)},n.prototype.cannot=function(){var t=this.can.apply(this,arguments);return t.rule.inverted=!0,t},n}();t.Ability=a,t.Rule=h,t.RuleBuilder=v,t.AbilityBuilder=i,t.ForbiddenError=u,Object.defineProperty(t,"__esModule",{value:!0})});
