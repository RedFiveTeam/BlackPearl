!function(e,n){"object"==typeof exports&&"undefined"!=typeof module?n(exports):"function"==typeof define&&define.amd?define(["exports"],n):n((e.casl=e.casl||{},e.casl.extra={}))}(this,function(e){"use strict";var o=function(e){return e.fields};var c=function(e){return Array.isArray(e)?e.join(","):e};e.rulesToQuery=function(e,n,r,t){for(var i={},o={},u=e.rulesFor(n,r),s=0;s<u.length;s++){var c=u[s],l=c.inverted?"$and":"$or";if(c.conditions)o.hasOwnProperty(l)||(i[l]=i[l]||[],i[l].push(t(c)));else{if(c.inverted)return null;i[l]&&delete i[l],o[l]=!0}}return 0<u.length?i:null},e.rulesToFields=function(e,n,r){return e.rulesFor(n,r).filter(function(e){return!e.inverted&&e.conditions}).reduce(function(e,t){return Object.keys(t.conditions).reduce(function(e,n){var r=t.conditions[n];return r&&r.constructor===Object||function(e,n,r){var t=e,i=n;if(-1!==n.indexOf(".")){var o=n.split(".");i=o.pop(),t=o.reduce(function(e,n){return e[n]=e[n]||{}},e)}t[i]=r}(e,n,r),e},e)},{})},e.permittedFieldsOf=function(e,n,r){var i=(3<arguments.length&&void 0!==arguments[3]?arguments[3]:{}).fieldsFrom||o,t=e.possibleRulesFor(n,r).slice(0).reverse().filter(function(e){return e.matches(r)}).reduce(function(e,n){var r=i(n);if(r){var t=n.inverted?"delete":"add";r.forEach(e[t],e)}return e},new Set);return Array.from(t)},e.packRules=function(e){return e.map(function(e){for(var n=e.actions,r=e.subject,t=e.conditions,i=e.inverted,o=e.fields,u=e.reason,s=[c(n),c(r),t||0,i?1:0,c(o)||0,u||0];!s[s.length-1];)s.pop();return s})},e.unpackRules=function(e){return e.map(function(e){var n=e[0],r=e[1],t=e[2],i=e[3],o=e[4],u=e[5];return{actions:n.split(","),subject:r.split(","),inverted:!!i,conditions:t||null,fields:o?o.split(","):null,reason:u||null}})},Object.defineProperty(e,"__esModule",{value:!0})});
